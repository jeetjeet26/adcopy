<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Ads Campaign Builder</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #4285f4;
            margin-top: 0;
        }
        h2 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .tab-container {
            margin-top: 20px;
        }
        .tab-nav {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab-link {
            padding: 10px 20px;
            cursor: pointer;
            color: #666;
            text-decoration: none;
        }
        .tab-link.active {
            border-bottom: 3px solid #4285f4;
            color: #4285f4;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], 
        input[type="url"], 
        input[type="number"],
        textarea, 
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: inherit;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3367d6;
        }
        .delete-btn {
            background-color: #ea4335;
        }
        .delete-btn:hover {
            background-color: #d62516;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .prev-btn {
            background-color: #fbbc05;
        }
        .prev-btn:hover {
            background-color: #e8ac04;
        }
        .next-btn {
            background-color: #34a853;
        }
        .next-btn:hover {
            background-color: #2d9146;
        }
        .campaign-item {
            background-color: #f1f8ff;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ad-group-item {
            background-color: #f1fff1;
            padding: 10px;
            margin-bottom: 5px;
            margin-left: 20px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .keyword-list {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .keyword-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .character-count {
            text-align: right;
            font-size: 12px;
            color: #666;
        }
        .error {
            color: #ea4335;
            font-size: 14px;
            margin-top: 5px;
        }
        .success {
            color: #34a853;
            font-size: 14px;
            margin-top: 5px;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            margin-left: 5px;
        }
        .badge-exact {
            background-color: #4285f4;
        }
        .badge-phrase {
            background-color: #34a853;
        }
        .badge-broad {
            background-color: #fbbc05;
        }
        .ai-badge {
            background-color: #4285f4;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 10px;
        }
        .flex-row {
            display: flex;
            gap: 20px;
        }
        .col-50 {
            flex: 1;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        
        /* Keywords table styles */
        #keywords-table {
            border: none;
        }
        
        #keywords-table th {
            user-select: none;
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f5f5f5;
        }
        
        #keywords-table th:hover {
            background-color: #e9ecef;
        }
        
        #keywords-table th.sortable.sorted-asc .sort-arrow {
            color: #4285f4;
        }
        
        #keywords-table th.sortable.sorted-desc .sort-arrow {
            color: #4285f4;
            transform: rotate(180deg);
        }
        
        #keywords-table th.sortable.sorted-asc .sort-arrow::before {
            content: 'â†‘';
        }
        
        #keywords-table th.sortable.sorted-desc .sort-arrow::before {
            content: 'â†“';
        }
        
        #keywords-table tbody tr {
            border-bottom: 1px solid #eee;
        }
        
        #keywords-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        #keywords-table tbody td {
            padding: 8px 10px;
            border-right: 1px solid #eee;
        }
        
        .keyword-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        
        .keyword-type-primary {
            background-color: #4285f4;
        }
        
        .keyword-type-longtail {
            background-color: #34a853;
        }
        
        .keyword-type-lowcomp {
            background-color: #fbbc05;
            color: #333;
        }
        
        .keyword-type-medium {
            background-color: #ea4335;
        }
        
        .add-keyword-btn {
            padding: 4px 8px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-keyword-btn:hover {
            background-color: #3367d6;
        }
        
        /* Campaign Structure Form Styles */
        .creation-form {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-top: 15px;
            transition: opacity 0.3s ease;
        }
        
        .creation-form h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #4285f4;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .save-btn {
            background-color: #34a853;
        }
        
        .save-btn:hover {
            background-color: #2d9146;
        }
        
        .cancel-btn {
            background-color: #ea4335;
        }
        
        .cancel-btn:hover {
            background-color: #d62516;
        }
        
        .campaign-list-item {
            margin-bottom: 15px;
        }
        
        .campaign-header {
            background-color: #e8f0fe;
            padding: 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .campaign-title {
            font-weight: bold;
            color: #1a73e8;
        }
        
        .ad-group-list {
            margin-left: 20px;
        }
        
        .ad-group-item-new {
            background-color: #f1fff1;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #34a853;
        }
        
        /* Keyword Coverage Analysis Styles */
        .coverage-analysis {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .coverage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .coverage-title {
            color: #4285f4;
            margin: 0;
            font-size: 18px;
        }
        
        .coverage-score {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .coverage-content {
            display: flex;
            gap: 20px;
        }
        
        .coverage-chart {
            flex: 1;
            max-width: 400px;
        }
        
        .coverage-details {
            flex: 1;
        }
        
        .coverage-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric-label {
            font-weight: 500;
            color: #333;
        }
        
        .metric-value {
            font-weight: bold;
            color: #4285f4;
        }
        
        .coverage-keywords {
            margin-top: 15px;
        }
        
        .keyword-coverage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            margin: 3px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .keyword-covered {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .keyword-partial {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .keyword-missing {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .coverage-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
        }
        
        .status-covered {
            background-color: #4caf50;
        }
        
        .status-partial {
            background-color: #ff9800;
        }
        
        .status-missing {
            background-color: #f44336;
        }
        
        .refresh-analysis-btn {
            background-color: #34a853;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .refresh-analysis-btn:hover {
            background-color: #2d9146;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Google Ads Campaign Builder <span class="ai-badge">AI-Powered</span></h1>
        
        <div class="tab-container">
            <div class="tab-nav">
                <a href="#client-info" class="tab-link active" data-tab="client-info">Client Information</a>
                <a href="#campaign-structure" class="tab-link" data-tab="campaign-structure">Campaign Structure</a>
                <a href="#keywords" class="tab-link" data-tab="keywords">Keywords</a>
                <a href="#ad-copy" class="tab-link" data-tab="ad-copy">Ad Copy</a>
                <a href="#export" class="tab-link" data-tab="export">Export</a>
            </div>
            
            <!-- Client Information Tab -->
            <div id="client-info-tab" class="tab-content active">
                <h2>Client Information</h2>
                <div class="form-group">
                    <label for="client-name">Client Name *</label>
                    <input type="text" id="client-name" placeholder="e.g., AMLI Residential">
                </div>
                <div class="form-group">
                    <label for="website-url">Website URL *</label>
                    <input type="url" id="website-url" placeholder="e.g., https://www.example.com">
                </div>
                <div class="form-group">
                    <label for="industry">Industry/Niche *</label>
                    <input type="text" id="industry" placeholder="e.g., Real Estate, Healthcare, Technology">
                </div>
                <div class="form-group">
                    <label for="target-audience">Target Audience (Demographics, Interests) *</label>
                    <textarea id="target-audience" placeholder="e.g., Adults 25-45, homeowners, interested in luxury living"></textarea>
                </div>
                <div class="form-group">
                    <label for="geographic-targeting">Geographic Targeting *</label>
                    <input type="text" id="geographic-targeting" placeholder="e.g., Chicago, IL metropolitan area">
                </div>
                <div class="form-group">
                    <label for="unique-selling-points">Unique Selling Points (3-5) *</label>
                    <textarea id="unique-selling-points" placeholder="e.g., 1. Luxury finishes and modern amenities&#10;2. Prime downtown location&#10;3. 24/7 concierge service"></textarea>
                </div>
                <div class="form-group">
                    <label for="competitors">Competitors (3-5)</label>
                    <input type="text" id="competitors" placeholder="e.g., Competitor A, Competitor B, Competitor C">
                </div>
                <div class="form-group">
                    <label for="brand-voice">Brand Voice/Tone *</label>
                    <textarea id="brand-voice" placeholder="e.g., Professional, upscale, friendly"></textarea>
                </div>
                <div class="form-group">
                    <label for="call-to-action">Call to Action Preferences *</label>
                    <input type="text" id="call-to-action" placeholder="e.g., Schedule a tour, Contact us, Learn more">
                </div>
                <div class="form-group">
                    <label for="budget">Budget Information</label>
                    <input type="text" id="budget" placeholder="e.g., $5,000/month">
                </div>
                <div class="nav-buttons">
                    <div></div>
                    <button class="next-btn" id="client-info-next">Next: Campaign Structure</button>
                </div>
            </div>
            
            <!-- Campaign Structure Tab -->
            <div id="campaign-structure-tab" class="tab-content">
                <h2>Campaign Structure</h2>
                <div class="flex-row">
                    <div style="width: 40%;">
                        <h3>Create New</h3>
                        <button id="add-campaign-btn" style="margin-right: 10px;">Add Campaign</button>
                        <button id="add-ad-group-btn">Add Ad Group</button>
                        
                        <!-- Campaign Creation Form -->
                        <div id="campaign-form" class="creation-form" style="display: none;">
                            <h4>Create New Campaign</h4>
                            <div class="form-group">
                                <label for="campaign-name-input">Campaign Name *</label>
                                <input type="text" id="campaign-name-input" placeholder="e.g., AMLI Downtown Luxury Apartments">
                                <div id="campaign-name-error" class="error"></div>
                            </div>
                            <div class="form-group">
                                <input type="checkbox" id="unit-type-checkbox">
                                <label for="unit-type-checkbox">Unit Type Campaign</label>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Check this if the campaign focuses on specific unit types (e.g., "Studio Apartments", "Two Bedroom Homes"). Leave unchecked for General Search campaigns with location-based targeting.
                                </div>
                            </div>
                            <div class="form-actions">
                                <button id="save-campaign-btn" class="save-btn">Create Campaign</button>
                                <button id="cancel-campaign-btn" class="cancel-btn">Cancel</button>
                            </div>
                            <div id="campaign-form-message" class="success"></div>
                        </div>
                        
                        <!-- Ad Group Creation Form -->
                        <div id="ad-group-form" class="creation-form" style="display: none;">
                            <h4>Create New Ad Group</h4>
                            <div class="form-group">
                                <label for="parent-campaign-select">Parent Campaign *</label>
                                <select id="parent-campaign-select">
                                    <option value="">Select a campaign</option>
                                </select>
                                <div id="parent-campaign-error" class="error"></div>
                            </div>
                            <div class="form-group">
                                <label for="ad-group-name-input">Ad Group Name *</label>
                                <input type="text" id="ad-group-name-input" placeholder="e.g., Studio Apartments, Downtown Location">
                                <div id="ad-group-name-error" class="error"></div>
                            </div>
                            <div class="form-actions">
                                <button id="save-ad-group-btn" class="save-btn">Create Ad Group</button>
                                <button id="cancel-ad-group-btn" class="cancel-btn">Cancel</button>
                            </div>
                            <div id="ad-group-form-message" class="success"></div>
                        </div>
                    </div>
                    <div style="width: 60%;">
                        <h3>Campaigns and Ad Groups</h3>
                        <div id="campaign-list">
                            <!-- Campaign items will be added here -->
                        </div>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="prev-btn" id="campaign-structure-prev">Previous: Client Information</button>
                    <button class="next-btn" id="campaign-structure-next">Next: Keywords</button>
                </div>
            </div>
            
            <!-- Keywords Tab -->
            <div id="keywords-tab" class="tab-content">
                <h2>Keywords</h2>
                
                <!-- Campaign & Ad Group Selection Section -->
                <div style="background-color: #f0f8ff; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #1a73e8;">ðŸ“‹ Step 1: Select Campaign & Ad Group</h3>
                    <p style="margin-bottom: 15px; color: #666;">Choose your campaign and ad group to generate targeted keywords.</p>
                    
                    <div class="flex-row">
                        <div class="col-50">
                            <div class="form-group">
                                <label for="keyword-campaign-select">Campaign *</label>
                                <select id="keyword-campaign-select">
                                    <option value="">Select a campaign</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-50">
                            <div class="form-group">
                                <label for="keyword-ad-group-select">Ad Group *</label>
                                <select id="keyword-ad-group-select">
                                    <option value="">Select an ad group</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Keyword Generation Section -->
                <div style="background-color: #f8f9ff; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #4285f4;">ðŸ¤– Step 2: Generate Keywords with AI</h3>
                    <p style="margin-bottom: 10px; color: #666;">Generate relevant keywords automatically based on your selected campaign and ad group using AI analysis and Semrush data.</p>
                    <button id="generate-keywords-btn" style="background-color: #4285f4; margin-right: 10px;">Generate Keywords <span class="ai-badge">AI</span></button>
                    <button id="clear-suggestions-btn" style="background-color: #ea4335; display: none;">Clear Suggestions</button>
                    
                    <div id="loading-keywords" class="loading">
                        <div class="loading-spinner"></div>
                        <p>Analyzing campaign and generating keywords...</p>
                    </div>
                    
                    <div id="keyword-suggestions" style="display: none; margin-top: 15px;">
                        <h4>Keyword Suggestions</h4>
                        <div style="overflow-x: auto; max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                            <table id="keywords-table" style="width: 100%; border-collapse: collapse; margin-top: 0;">
                                <thead>
                                    <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                        <th class="sortable" data-sort="type" style="padding: 10px; text-align: left; cursor: pointer; border-right: 1px solid #ddd;">
                                            Type <span class="sort-arrow">â†•</span>
                                        </th>
                                        <th class="sortable" data-sort="keyword" style="padding: 10px; text-align: left; cursor: pointer; border-right: 1px solid #ddd;">
                                            Keyword <span class="sort-arrow">â†•</span>
                                        </th>
                                        <th class="sortable" data-sort="searchVolume" style="padding: 10px; text-align: right; cursor: pointer; border-right: 1px solid #ddd;">
                                            Search Volume <span class="sort-arrow">â†•</span>
                                        </th>
                                        <th class="sortable" data-sort="cpc" style="padding: 10px; text-align: right; cursor: pointer; border-right: 1px solid #ddd;">
                                            CPC <span class="sort-arrow">â†•</span>
                                        </th>
                                        <th class="sortable" data-sort="competition" style="padding: 10px; text-align: right; cursor: pointer; border-right: 1px solid #ddd;">
                                            Competition <span class="sort-arrow">â†•</span>
                                        </th>
                                        <th class="sortable" data-sort="results" style="padding: 10px; text-align: right; cursor: pointer; border-right: 1px solid #ddd;">
                                            Results <span class="sort-arrow">â†•</span>
                                        </th>
                                        <th class="sortable" data-sort="intent" style="padding: 10px; text-align: left; cursor: pointer; border-right: 1px solid #ddd;">
                                            Intent <span class="sort-arrow">â†•</span>
                                        </th>
                                        <th style="padding: 10px; text-align: center;">
                                            Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="keywords-table-body">
                                    <!-- Keywords will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="flex-row">
                    <div class="col-50">
                        <h3>Step 3: Add Keywords</h3>
                        <div class="form-group">
                            <label for="keywords-input">Keywords (one per line)</label>
                            <textarea id="keywords-input" placeholder="Enter keywords manually OR use AI generator above"></textarea>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="exact-match" checked>
                            <label for="exact-match">Exact Match</label>
                            
                            <input type="checkbox" id="phrase-match">
                            <label for="phrase-match">Phrase Match</label>
                            
                            <input type="checkbox" id="broad-match">
                            <label for="broad-match">Broad Match</label>
                        </div>
                        <button id="add-keywords-btn">Add Keywords</button>
                    </div>
                    <div class="col-50">
                        <h3>Keyword List</h3>
                        <div id="keyword-list-container">
                            <div class="keyword-list">
                                <p>Select an ad group to view keywords</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="prev-btn" id="keywords-prev">Previous: Campaign Structure</button>
                    <button class="next-btn" id="keywords-next">Next: Ad Copy</button>
                </div>
            </div>
            
            <!-- Ad Copy Tab -->
            <div id="ad-copy-tab" class="tab-content">
                <h2>Ad Copy</h2>
                <div class="flex-row">
                    <div class="col-50">
                        <h3>Create Ad</h3>
                        <div class="form-group">
                            <label for="ad-campaign-select">Campaign</label>
                            <select id="ad-campaign-select">
                                <option value="">Select a campaign</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ad-group-select">Ad Group</label>
                            <select id="ad-group-select">
                                <option value="">Select an ad group</option>
                            </select>
                        </div>
                        <button id="generate-ad-copy">Generate Ad Copy</button>
                        
                        <div id="loading-ad-copy" class="loading">
                            <div class="loading-spinner"></div>
                            <p>Generating AI-powered ad copy...</p>
                        </div>
                        
                        <h4>Headlines</h4>
                        <div class="form-group">
                            <label for="headline1">Headline 1 (25-30 chars)</label>
                            <input type="text" id="headline1" maxlength="30">
                            <div class="character-count" id="headline1-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline2">Headline 2 (25-30 chars)</label>
                            <input type="text" id="headline2" maxlength="30">
                            <div class="character-count" id="headline2-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline3">Headline 3 (25-30 chars)</label>
                            <input type="text" id="headline3" maxlength="30">
                            <div class="character-count" id="headline3-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline4">Headline 4 (25-30 chars)</label>
                            <input type="text" id="headline4" maxlength="30">
                            <div class="character-count" id="headline4-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline5">Headline 5 (25-30 chars)</label>
                            <input type="text" id="headline5" maxlength="30">
                            <div class="character-count" id="headline5-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline6">Headline 6 (25-30 chars)</label>
                            <input type="text" id="headline6" maxlength="30">
                            <div class="character-count" id="headline6-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline7">Headline 7 (25-30 chars)</label>
                            <input type="text" id="headline7" maxlength="30">
                            <div class="character-count" id="headline7-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline8">Headline 8 (25-30 chars)</label>
                            <input type="text" id="headline8" maxlength="30">
                            <div class="character-count" id="headline8-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline9">Headline 9 (25-30 chars)</label>
                            <input type="text" id="headline9" maxlength="30">
                            <div class="character-count" id="headline9-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline10">Headline 10 (25-30 chars)</label>
                            <input type="text" id="headline10" maxlength="30">
                            <div class="character-count" id="headline10-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline11">Headline 11 (25-30 chars)</label>
                            <input type="text" id="headline11" maxlength="30">
                            <div class="character-count" id="headline11-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline12">Headline 12 (25-30 chars)</label>
                            <input type="text" id="headline12" maxlength="30">
                            <div class="character-count" id="headline12-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline13">Headline 13 (25-30 chars)</label>
                            <input type="text" id="headline13" maxlength="30">
                            <div class="character-count" id="headline13-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline14">Headline 14 (25-30 chars)</label>
                            <input type="text" id="headline14" maxlength="30">
                            <div class="character-count" id="headline14-count">0/30</div>
                        </div>
                        <div class="form-group">
                            <label for="headline15">Headline 15 (25-30 chars)</label>
                            <input type="text" id="headline15" maxlength="30">
                            <div class="character-count" id="headline15-count">0/30</div>
                        </div>
                        
                        <h4>Descriptions</h4>
                        <div class="form-group">
                            <label for="description1">Description 1 (90 char max)</label>
                            <textarea id="description1" maxlength="90"></textarea>
                            <div class="character-count" id="description1-count">0/90</div>
                        </div>
                        <div class="form-group">
                            <label for="description2">Description 2 (90 char max)</label>
                            <textarea id="description2" maxlength="90"></textarea>
                            <div class="character-count" id="description2-count">0/90</div>
                        </div>
                        <div class="form-group">
                            <label for="description3">Description 3 (90 char max)</label>
                            <textarea id="description3" maxlength="90"></textarea>
                            <div class="character-count" id="description3-count">0/90</div>
                        </div>
                        <div class="form-group">
                            <label for="description4">Description 4 (90 char max)</label>
                            <textarea id="description4" maxlength="90"></textarea>
                            <div class="character-count" id="description4-count">0/90</div>
                        </div>
                        
                        <button id="save-ad-btn">Save Ad</button>
                        <div id="ad-save-message" class="success"></div>
                    </div>
                    <div class="col-50">
                        <h3>Ads</h3>
                        <div id="ads-list-container">
                            <div class="keyword-list">
                                <p>No ads in this ad group</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Keyword Coverage Analysis Section -->
                <div id="keyword-coverage-analysis" class="coverage-analysis" style="display: none;">
                    <div class="coverage-header">
                        <h3 class="coverage-title">ðŸŽ¯ Keyword Coverage Analysis</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div id="coverage-score" class="coverage-score">Coverage: 0%</div>
                            <button id="refresh-analysis-btn" class="refresh-analysis-btn">Refresh Analysis</button>
                        </div>
                    </div>
                    <div class="coverage-content">
                        <div class="coverage-chart">
                            <canvas id="coverage-chart" width="300" height="300"></canvas>
                        </div>
                        <div class="coverage-details">
                            <div class="coverage-metric">
                                <span class="metric-label">Total Keywords:</span>
                                <span id="total-keywords" class="metric-value">0</span>
                            </div>
                            <div class="coverage-metric">
                                <span class="metric-label">Fully Covered:</span>
                                <span id="covered-keywords" class="metric-value">0</span>
                            </div>
                            <div class="coverage-metric">
                                <span class="metric-label">Partially Covered:</span>
                                <span id="partial-keywords" class="metric-value">0</span>
                            </div>
                            <div class="coverage-metric">
                                <span class="metric-label">Not Covered:</span>
                                <span id="missing-keywords" class="metric-value">0</span>
                            </div>
                            <div class="coverage-keywords">
                                <h4>Keyword Details:</h4>
                                <div id="keyword-coverage-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="prev-btn" id="ad-copy-prev">Previous: Keywords</button>
                    <button class="next-btn" id="ad-copy-next">Next: Export</button>
                </div>
            </div>
            
            <!-- Export Tab -->
            <div id="export-tab" class="tab-content">
                <h2>Export</h2>
                <div class="form-group">
                    <label for="export-campaign-select">Campaign</label>
                    <select id="export-campaign-select">
                        <option value="">Select a campaign</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="export-format">Export Format</label>
                    <select id="export-format">
                        <option value="csv">CSV (Google Ads Editor)</option>
                        <option value="excel">Excel</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                <button id="export-btn">Export Campaign</button>
                <div id="export-result"></div>
                <div class="nav-buttons">
                    <button class="prev-btn" id="export-prev">Previous: Ad Copy</button>
                    <div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Load JavaScript files -->
    <script src="openai_config.js"></script>
    <script src="openai_connector.js"></script>
    <script src="agentic_ad_copy_generator.js"></script>
    <script src="error_handling.js"></script>
    
    <script>
        // DOM Elements
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Navigation buttons
        const clientInfoNextBtn = document.getElementById('client-info-next');
        const campaignStructurePrevBtn = document.getElementById('campaign-structure-prev');
        const campaignStructureNextBtn = document.getElementById('campaign-structure-next');
        const keywordsPrevBtn = document.getElementById('keywords-prev');
        const keywordsNextBtn = document.getElementById('keywords-next');
        const adCopyPrevBtn = document.getElementById('ad-copy-prev');
        const adCopyNextBtn = document.getElementById('ad-copy-next');
        const exportPrevBtn = document.getElementById('export-prev');
        
        // Campaign Structure elements
        const addCampaignBtn = document.getElementById('add-campaign-btn');
        const addAdGroupBtn = document.getElementById('add-ad-group-btn');
        const campaignList = document.getElementById('campaign-list');
        
        // Campaign form elements
        const campaignForm = document.getElementById('campaign-form');
        const campaignNameInput = document.getElementById('campaign-name-input');
        const unitTypeCheckbox = document.getElementById('unit-type-checkbox');
        const saveCampaignBtn = document.getElementById('save-campaign-btn');
        const cancelCampaignBtn = document.getElementById('cancel-campaign-btn');
        const campaignFormMessage = document.getElementById('campaign-form-message');
        const campaignNameError = document.getElementById('campaign-name-error');
        
        // Ad Group form elements
        const adGroupForm = document.getElementById('ad-group-form');
        const parentCampaignSelect = document.getElementById('parent-campaign-select');
        const adGroupNameInput = document.getElementById('ad-group-name-input');
        const saveAdGroupBtn = document.getElementById('save-ad-group-btn');
        const cancelAdGroupBtn = document.getElementById('cancel-ad-group-btn');
        const adGroupFormMessage = document.getElementById('ad-group-form-message');
        const parentCampaignError = document.getElementById('parent-campaign-error');
        const adGroupNameError = document.getElementById('ad-group-name-error');
        
        // Keywords elements
        const keywordCampaignSelect = document.getElementById('keyword-campaign-select');
        const keywordAdGroupSelect = document.getElementById('keyword-ad-group-select');
        const keywordsInput = document.getElementById('keywords-input');
        const exactMatchCheckbox = document.getElementById('exact-match');
        const phraseMatchCheckbox = document.getElementById('phrase-match');
        const broadMatchCheckbox = document.getElementById('broad-match');
        const addKeywordsBtn = document.getElementById('add-keywords-btn');
        const keywordListContainer = document.getElementById('keyword-list-container');
        
        // AI Keyword Generation elements
        const generateKeywordsBtn = document.getElementById('generate-keywords-btn');
        const clearSuggestionsBtn = document.getElementById('clear-suggestions-btn');
        const loadingKeywords = document.getElementById('loading-keywords');
        const keywordSuggestions = document.getElementById('keyword-suggestions');
        const keywordsTable = document.getElementById('keywords-table');
        const keywordsTableBody = document.getElementById('keywords-table-body');
        
        // Ad Copy elements
        const adCampaignSelect = document.getElementById('ad-campaign-select');
        const adGroupSelect = document.getElementById('ad-group-select');
        const generateAdCopyBtn = document.getElementById('generate-ad-copy');
        const loadingAdCopy = document.getElementById('loading-ad-copy');
        const headline1 = document.getElementById('headline1');
        const headline2 = document.getElementById('headline2');
        const headline3 = document.getElementById('headline3');
        const headline4 = document.getElementById('headline4');
        const headline5 = document.getElementById('headline5');
        const headline6 = document.getElementById('headline6');
        const headline7 = document.getElementById('headline7');
        const headline8 = document.getElementById('headline8');
        const headline9 = document.getElementById('headline9');
        const headline10 = document.getElementById('headline10');
        const headline11 = document.getElementById('headline11');
        const headline12 = document.getElementById('headline12');
        const headline13 = document.getElementById('headline13');
        const headline14 = document.getElementById('headline14');
        const headline15 = document.getElementById('headline15');
        const description1 = document.getElementById('description1');
        const description2 = document.getElementById('description2');
        const description3 = document.getElementById('description3');
        const description4 = document.getElementById('description4');
        const headline1Count = document.getElementById('headline1-count');
        const headline2Count = document.getElementById('headline2-count');
        const headline3Count = document.getElementById('headline3-count');
        const headline4Count = document.getElementById('headline4-count');
        const headline5Count = document.getElementById('headline5-count');
        const headline6Count = document.getElementById('headline6-count');
        const headline7Count = document.getElementById('headline7-count');
        const headline8Count = document.getElementById('headline8-count');
        const headline9Count = document.getElementById('headline9-count');
        const headline10Count = document.getElementById('headline10-count');
        const headline11Count = document.getElementById('headline11-count');
        const headline12Count = document.getElementById('headline12-count');
        const headline13Count = document.getElementById('headline13-count');
        const headline14Count = document.getElementById('headline14-count');
        const headline15Count = document.getElementById('headline15-count');
        const description1Count = document.getElementById('description1-count');
        const description2Count = document.getElementById('description2-count');
        const description3Count = document.getElementById('description3-count');
        const description4Count = document.getElementById('description4-count');
        const saveAdBtn = document.getElementById('save-ad-btn');
        const adSaveMessage = document.getElementById('ad-save-message');
        const adsListContainer = document.getElementById('ads-list-container');
        
        // Keyword Coverage Analysis elements
        const keywordCoverageAnalysis = document.getElementById('keyword-coverage-analysis');
        const coverageScore = document.getElementById('coverage-score');
        const refreshAnalysisBtn = document.getElementById('refresh-analysis-btn');
        const totalKeywordsEl = document.getElementById('total-keywords');
        const coveredKeywordsEl = document.getElementById('covered-keywords');
        const partialKeywordsEl = document.getElementById('partial-keywords');
        const missingKeywordsEl = document.getElementById('missing-keywords');
        const keywordCoverageList = document.getElementById('keyword-coverage-list');
        
        // Export elements
        const exportCampaignSelect = document.getElementById('export-campaign-select');
        const exportFormatSelect = document.getElementById('export-format');
        const exportBtn = document.getElementById('export-btn');
        const exportResult = document.getElementById('export-result');
        
        // Client Information elements
        const clientName = document.getElementById('client-name');
        const websiteUrl = document.getElementById('website-url');
        const industry = document.getElementById('industry');
        const targetAudience = document.getElementById('target-audience');
        const geographicTargeting = document.getElementById('geographic-targeting');
        const uniqueSellingPoints = document.getElementById('unique-selling-points');
        const competitors = document.getElementById('competitors');
        const brandVoice = document.getElementById('brand-voice');
        const callToAction = document.getElementById('call-to-action');
        const budget = document.getElementById('budget');
        
        // Data Storage
        let campaignsData = {};
        window.campaignsData = campaignsData; // Make it globally accessible
        
        // Initialize the application
        function init() {
            // Load data from localStorage if available
            loadData();
            
            // Set up tab navigation
            setupTabs();
            
            // Set up navigation buttons
            setupNavigation();
            
            // Set up campaign structure functionality
            setupCampaignStructure();
            
            // Set up keywords functionality
            setupKeywords();
            
            // Set up ad copy functionality
            setupAdCopy();
            
            // Set up export functionality
            setupExport();
            
            // Set up character counters
            setupCharacterCounters();
            
            // Render initial data
            renderCampaigns();
            updateSelects();
        }
        
        // Tab Navigation
        function setupTabs() {
            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = link.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    tabLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to current tab
                    link.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }
        
        // Navigation Buttons
        function setupNavigation() {
            clientInfoNextBtn.addEventListener('click', () => {
                saveClientInfo();
                navigateToTab('campaign-structure');
            });
            
            campaignStructurePrevBtn.addEventListener('click', () => {
                navigateToTab('client-info');
            });
            
            campaignStructureNextBtn.addEventListener('click', () => {
                navigateToTab('keywords');
            });
            
            keywordsPrevBtn.addEventListener('click', () => {
                navigateToTab('campaign-structure');
            });
            
            keywordsNextBtn.addEventListener('click', () => {
                navigateToTab('ad-copy');
            });
            
            adCopyPrevBtn.addEventListener('click', () => {
                navigateToTab('keywords');
            });
            
            adCopyNextBtn.addEventListener('click', () => {
                navigateToTab('export');
            });
            
            exportPrevBtn.addEventListener('click', () => {
                navigateToTab('ad-copy');
            });
        }
        
        function navigateToTab(tabId) {
            const tabLink = document.querySelector(`.tab-link[data-tab="${tabId}"]`);
            if (tabLink) {
                tabLink.click();
            }
        }
        
        // Campaign Structure
        function setupCampaignStructure() {
            // Show campaign form
            addCampaignBtn.addEventListener('click', () => {
                hideForms();
                campaignForm.style.display = 'block';
                clearCampaignForm();
            });
            
            // Show ad group form
            addAdGroupBtn.addEventListener('click', () => {
                if (Object.keys(campaignsData).length === 0) {
                    alert('Please create a campaign first.');
                    return;
                }
                hideForms();
                updateParentCampaignSelect();
                adGroupForm.style.display = 'block';
                clearAdGroupForm();
            });
            
            // Campaign form handlers
            saveCampaignBtn.addEventListener('click', () => {
                if (validateCampaignForm()) {
                    const campaignName = campaignNameInput.value.trim();
                    const isUnitType = unitTypeCheckbox.checked;
                    addCampaign(campaignName, isUnitType);
                    showCampaignFormMessage('Campaign created successfully!');
                    setTimeout(() => {
                        hideForms();
                    }, 1500);
                }
            });
            
            cancelCampaignBtn.addEventListener('click', () => {
                hideForms();
            });
            
            // Ad group form handlers
            saveAdGroupBtn.addEventListener('click', () => {
                if (validateAdGroupForm()) {
                    const campaignId = parentCampaignSelect.value;
                    const adGroupName = adGroupNameInput.value.trim();
                    addAdGroup(campaignId, adGroupName);
                    showAdGroupFormMessage('Ad group created successfully!');
                    setTimeout(() => {
                        hideForms();
                    }, 1500);
                }
            });
            
            cancelAdGroupBtn.addEventListener('click', () => {
                hideForms();
            });
        }
        
        function hideForms() {
            campaignForm.style.display = 'none';
            adGroupForm.style.display = 'none';
            clearFormMessages();
        }
        
        function clearCampaignForm() {
            campaignNameInput.value = '';
            unitTypeCheckbox.checked = false;
            campaignNameError.textContent = '';
        }
        
        function clearAdGroupForm() {
            parentCampaignSelect.value = '';
            adGroupNameInput.value = '';
            parentCampaignError.textContent = '';
            adGroupNameError.textContent = '';
        }
        
        function clearFormMessages() {
            campaignFormMessage.textContent = '';
            adGroupFormMessage.textContent = '';
        }
        
        function validateCampaignForm() {
            let isValid = true;
            campaignNameError.textContent = '';
            
            if (!campaignNameInput.value.trim()) {
                campaignNameError.textContent = 'Campaign name is required';
                isValid = false;
            }
            
            return isValid;
        }
        
        function validateAdGroupForm() {
            let isValid = true;
            parentCampaignError.textContent = '';
            adGroupNameError.textContent = '';
            
            if (!parentCampaignSelect.value) {
                parentCampaignError.textContent = 'Please select a parent campaign';
                isValid = false;
            }
            
            if (!adGroupNameInput.value.trim()) {
                adGroupNameError.textContent = 'Ad group name is required';
                isValid = false;
            }
            
            return isValid;
        }
        
        function showCampaignFormMessage(message) {
            campaignFormMessage.textContent = message;
        }
        
        function showAdGroupFormMessage(message) {
            adGroupFormMessage.textContent = message;
        }
        
        function updateParentCampaignSelect() {
            parentCampaignSelect.innerHTML = '<option value="">Select a campaign</option>';
            
            for (const campaignId in campaignsData) {
                const campaign = campaignsData[campaignId];
                const unitTypeIndicator = campaign.isUnitType ? ' (Unit Type)' : '';
                
                const option = document.createElement('option');
                option.value = campaignId;
                option.textContent = campaign.name + unitTypeIndicator;
                
                parentCampaignSelect.appendChild(option);
            }
        }
        
        function addCampaign(name, isUnitType = false) {
            const campaignId = 'campaign' + (Object.keys(campaignsData).length + 1);
            const clientInfo = getClientInfo();
            campaignsData[campaignId] = {
                name: name,
                adGroups: {},
                keywords: {},
                ads: {},
                isUnitType: isUnitType,
                budget: clientInfo.budget || ''
            };
            
            // For General Search campaigns (isUnitType=false), automatically create "Location" ad group
            if (!isUnitType) {
                const locationAdGroupId = 'adgroup_location_' + Date.now();
                campaignsData[campaignId].adGroups[locationAdGroupId] = {
                    name: 'Location',
                    keywords: [],
                    ads: [],
                    isLocationAdGroup: true // Flag to identify this as the special location ad group
                };
            }
            
            saveData();
            renderCampaigns();
            updateSelects();
        }
        
        function addAdGroup(campaignId, name) {
            const adGroupId = 'adgroup_' + Date.now();
            if (!campaignsData[campaignId].adGroups) {
                campaignsData[campaignId].adGroups = {};
            }
            
            campaignsData[campaignId].adGroups[adGroupId] = {
                name: name,
                keywords: [],
                ads: []
            };
            
            saveData();
            renderCampaigns();
            updateSelects();
        }
        
        function deleteCampaign(campaignId) {
            delete campaignsData[campaignId];
            saveData();
            renderCampaigns();
            updateSelects();
        }
        
        function deleteAdGroup(campaignId, adGroupId) {
            delete campaignsData[campaignId].adGroups[adGroupId];
            saveData();
            renderCampaigns();
            updateSelects();
        }
        
        function renderCampaigns() {
            campaignList.innerHTML = '';
            
            if (Object.keys(campaignsData).length === 0) {
                campaignList.innerHTML = '<p style="color: #666; font-style: italic;">No campaigns created yet. Click "Add Campaign" to get started.</p>';
                return;
            }
            
            for (const campaignId in campaignsData) {
                const campaign = campaignsData[campaignId];
                
                // Create campaign container
                const campaignContainer = document.createElement('div');
                campaignContainer.className = 'campaign-list-item';
                
                // Create campaign header
                const campaignHeader = document.createElement('div');
                campaignHeader.className = 'campaign-header';
                
                const unitTypeIndicator = campaign.isUnitType ? ' <span style="background: #ffe58f; color: #ad8b00; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold;">UNIT TYPE</span>' : '';
                
                campaignHeader.innerHTML = `
                    <div class="campaign-title">${campaign.name}${unitTypeIndicator}</div>
                    <button class="delete-btn" data-campaign-id="${campaignId}">Delete Campaign</button>
                `;
                
                campaignContainer.appendChild(campaignHeader);
                
                // Add event listener to delete button
                campaignHeader.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Are you sure you want to delete the campaign "${campaign.name}" and all its ad groups?`)) {
                        deleteCampaign(campaignId);
                    }
                });
                
                // Create ad groups container
                const adGroupsContainer = document.createElement('div');
                adGroupsContainer.className = 'ad-group-list';
                
                // Render ad groups for this campaign
                if (campaign.adGroups && Object.keys(campaign.adGroups).length > 0) {
                    for (const adGroupId in campaign.adGroups) {
                        const adGroup = campaign.adGroups[adGroupId];
                        
                        // Create ad group item
                        const adGroupItem = document.createElement('div');
                        adGroupItem.className = 'ad-group-item-new';
                        adGroupItem.innerHTML = `
                            <div>${adGroup.name}</div>
                            <button class="delete-btn" data-ad-group-id="${adGroupId}" style="font-size: 12px; padding: 4px 8px;">Delete</button>
                        `;
                        
                        // Add event listener to delete button
                        adGroupItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm(`Are you sure you want to delete the ad group "${adGroup.name}"?`)) {
                                deleteAdGroup(campaignId, adGroupId);
                            }
                        });
                        
                        adGroupsContainer.appendChild(adGroupItem);
                    }
                } else {
                    adGroupsContainer.innerHTML = '<p style="color: #666; font-size: 14px; margin: 10px 0;">No ad groups in this campaign</p>';
                }
                
                campaignContainer.appendChild(adGroupsContainer);
                campaignList.appendChild(campaignContainer);
            }
        }
        
        // Keywords
        function setupKeywords() {
            keywordCampaignSelect.addEventListener('change', () => {
                updateAdGroupSelect(keywordCampaignSelect.value, keywordAdGroupSelect);
                updateKeywordList();
                showUnitTypeNote();
            });
            
            keywordAdGroupSelect.addEventListener('change', () => {
                updateKeywordList();
                showUnitTypeNote();
            });
            
            // AI Keyword Generation
            generateKeywordsBtn.addEventListener('click', async () => {
                try {
                    const campaignId = keywordCampaignSelect.value;
                    const adGroupId = keywordAdGroupSelect.value;
                    
                    // Validate campaign and ad group selection first
                    if (!campaignId || !adGroupId) {
                        alert('Please select both a campaign and ad group before generating keywords.');
                        return;
                    }
                    
                    const clientInfo = getClientInfo();
                    let campaignContext = null;
                    let adGroupContext = null;
                    let onlyUseAdGroupName = false;
                    
                    if (campaignId && campaignsData[campaignId]) {
                        campaignContext = {
                            id: campaignId,
                            name: campaignsData[campaignId].name,
                            objective: campaignsData[campaignId].objective || '',
                            budget: campaignsData[campaignId].budget || '',
                            isUnitType: campaignsData[campaignId].isUnitType || false
                        };
                        
                        if (campaignsData[campaignId].isUnitType) {
                            onlyUseAdGroupName = true;
                        }
                        
                        if (adGroupId && campaignsData[campaignId].adGroups && campaignsData[campaignId].adGroups[adGroupId]) {
                            const adGroup = campaignsData[campaignId].adGroups[adGroupId];
                            
                            // DEBUG: Log clientInfo to see its structure
                            console.log('=== DEBUG CLIENT INFO ===');
                            console.log('clientInfo object:', clientInfo);
                            console.log('clientInfo keys:', Object.keys(clientInfo));
                            console.log('uniqueSellingPoints:', clientInfo.uniqueSellingPoints);
                            console.log('brandVoice:', clientInfo.brandVoice);
                            console.log('industry:', clientInfo.industry);
                            console.log('targetAudience:', clientInfo.targetAudience);
                            console.log('========================');
                            
                            // Create theme from client info if not set at ad group level
                            let theme = adGroup.theme || '';
                            if (!theme) {
                                const themeParts = [];
                                if (clientInfo.uniqueSellingPoints) themeParts.push(clientInfo.uniqueSellingPoints);
                                if (clientInfo.brandVoice) themeParts.push(clientInfo.brandVoice);
                                if (clientInfo.industry) themeParts.push(clientInfo.industry);
                                if (adGroup.name) themeParts.push(`focused on ${adGroup.name}`);
                                theme = themeParts.join(', ');
                            }
                            
                            console.log('=== DEBUG THEME BUILDING ===');
                            console.log('adGroup.theme:', adGroup.theme);
                            console.log('computed theme:', theme);
                            console.log('============================');
                            
                            adGroupContext = {
                                id: adGroupId,
                                name: adGroup.name,
                                theme: theme,
                                targetAudience: adGroup.targetAudience || clientInfo.targetAudience || ''
                            };
                            
                            console.log('=== DEBUG FINAL ADGROUP CONTEXT ===');
                            console.log('adGroupContext:', adGroupContext);
                            console.log('===================================');
                        }
                    }
                    
                    // Show loading
                    loadingKeywords.style.display = 'block';
                    keywordSuggestions.style.display = 'none';
                    generateKeywordsBtn.disabled = true;
                    
                    // If unit type, only send ad group name as context
                    let payload;
                    if (onlyUseAdGroupName && adGroupContext) {
                        payload = {
                            clientInfo: {}, // ignore client info
                            campaignContext: null, // ignore campaign context
                            adGroupContext: { name: adGroupContext.name }
                        };
                    } else {
                        payload = {
                            clientInfo,
                            campaignContext,
                            adGroupContext
                        };
                    }
                    
                    const response = await fetch('/api/generate-keywords', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        
                        // Handle specific error types
                        if (response.status === 503 && errorData.code === 'SEMRUSH_NOT_CONFIGURED') {
                            throw new Error('Semrush API integration is required for keyword generation.\n\nPlease:\n1. Get a Semrush API key from https://www.semrush.com/api-documentation/\n2. Add SEMRUSH_API_KEY=your_key_here to your .env file\n3. Restart the server');
                        } else {
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        displayKeywordSuggestions(result.data);
                    } else {
                        // Handle specific cases
                        if (result.reason === 'Semrush API key not configured') {
                            const instructionText = result.instructions ? 
                                result.instructions.steps.join('\n') : 
                                'Please configure Semrush API key';
                            throw new Error(`${result.message}\n\n${instructionText}`);
                        }
                        throw new Error(result.message || result.error || 'Failed to generate keywords');
                    }
                    
                } catch (error) {
                    console.error('Error generating keywords:', error);
                    alert(error.message || 'Failed to generate keywords. Please check your connection and try again.');
                } finally {
                    loadingKeywords.style.display = 'none';
                    generateKeywordsBtn.disabled = false;
                }
            });
            
            clearSuggestionsBtn.addEventListener('click', () => {
                keywordSuggestions.style.display = 'none';
                clearSuggestionsBtn.style.display = 'none';
            });
            
            addKeywordsBtn.addEventListener('click', () => {
                const campaignId = keywordCampaignSelect.value;
                const adGroupId = keywordAdGroupSelect.value;
                const keywords = keywordsInput.value.trim().split('\n').filter(k => k.trim() !== '');
                
                if (!campaignId || !adGroupId) {
                    alert('Please select a campaign and ad group.');
                    return;
                }
                
                if (keywords.length === 0) {
                    alert('Please enter at least one keyword.');
                    return;
                }
                
                const matchTypes = [];
                if (exactMatchCheckbox.checked) matchTypes.push('exact');
                if (phraseMatchCheckbox.checked) matchTypes.push('phrase');
                if (broadMatchCheckbox.checked) matchTypes.push('broad');
                
                if (matchTypes.length === 0) {
                    alert('Please select at least one match type.');
                    return;
                }
                
                addKeywords(campaignId, adGroupId, keywords, matchTypes);
                keywordsInput.value = '';
            });
        }
        
        let currentSortColumn = '';
        let currentSortDirection = 'asc';
        let allKeywordsData = [];

        function displayKeywordSuggestions(data) {
            console.log('Displaying keyword suggestions:', data); // Debug log
            
            // Check if data is valid
            if (!data) {
                console.error('No data received for keyword suggestions');
                alert('No keyword data received. Please try again.');
                return;
            }
            
            // Collect all keywords with their types
            allKeywordsData = [];
            
            // Add primary keywords (High Volume)
            if (data.keywords && data.keywords.highVolume && data.keywords.highVolume.length > 0) {
                data.keywords.highVolume.slice(0, 20).forEach(kw => {
                    allKeywordsData.push({...kw, type: 'Primary'});
                });
            }
            
            // Add long-tail keywords
            if (data.recommendations && data.recommendations.longTail && data.recommendations.longTail.length > 0) {
                data.recommendations.longTail.slice(0, 20).forEach(kw => {
                    allKeywordsData.push({...kw, type: 'Long-tail'});
                });
            }
            
            // Add low competition keywords
            if (data.keywords && data.keywords.lowCompetition && data.keywords.lowCompetition.length > 0) {
                data.keywords.lowCompetition.slice(0, 20).forEach(kw => {
                    allKeywordsData.push({...kw, type: 'Low Competition'});
                });
            }
            
            // Add medium volume keywords
            if (data.keywords && data.keywords.mediumVolume && data.keywords.mediumVolume.length > 0) {
                data.keywords.mediumVolume.slice(0, 20).forEach(kw => {
                    allKeywordsData.push({...kw, type: 'Medium Volume'});
                });
            }
            
            // Remove duplicates based on keyword text
            const uniqueKeywords = [];
            const seenKeywords = new Set();
            
            allKeywordsData.forEach(kw => {
                if (!seenKeywords.has(kw.keyword.toLowerCase())) {
                    seenKeywords.add(kw.keyword.toLowerCase());
                    uniqueKeywords.push(kw);
                }
            });
            
            allKeywordsData = uniqueKeywords;
            
            // Check if we have any keywords after processing
            if (allKeywordsData.length === 0) {
                console.warn('No keywords found in data structure:', data);
                alert('No keywords were generated. This might be due to:\n\n1. Semrush API configuration issue\n2. No relevant keywords found for your search terms\n3. API rate limits\n\nPlease check your configuration and try again.');
                return;
            }
            
            // Populate the table
            populateKeywordsTable(allKeywordsData);
            
            // Setup sorting
            setupTableSorting();
            
            // Show the suggestions and clear button
            keywordSuggestions.style.display = 'block';
            clearSuggestionsBtn.style.display = 'inline-block';
        }

        function populateKeywordsTable(keywords) {
            keywordsTableBody.innerHTML = '';
            
            if (keywords.length === 0) {
                const noResultsRow = document.createElement('tr');
                const noResultsCell = document.createElement('td');
                noResultsCell.setAttribute('colspan', '8');
                noResultsCell.style.textAlign = 'center';
                noResultsCell.style.padding = '20px';
                noResultsCell.style.color = '#666';
                noResultsCell.textContent = 'No keywords found';
                noResultsRow.appendChild(noResultsCell);
                keywordsTableBody.appendChild(noResultsRow);
                return;
            }
            
            keywords.forEach(kw => {
                const row = document.createElement('tr');
                
                // Get type badge class
                let badgeClass = 'keyword-type-primary';
                switch(kw.type) {
                    case 'Long-tail':
                        badgeClass = 'keyword-type-longtail';
                        break;
                    case 'Low Competition':
                        badgeClass = 'keyword-type-lowcomp';
                        break;
                    case 'Medium Volume':
                        badgeClass = 'keyword-type-medium';
                        break;
                }
                
                // Create type cell
                const typeCell = document.createElement('td');
                const typeBadge = document.createElement('span');
                typeBadge.className = `keyword-type-badge ${badgeClass}`;
                typeBadge.textContent = kw.type || '';
                typeCell.appendChild(typeBadge);
                
                // Create keyword cell
                const keywordCell = document.createElement('td');
                keywordCell.style.fontWeight = 'bold';
                keywordCell.textContent = kw.keyword || '';
                
                // Create search volume cell
                const searchVolumeCell = document.createElement('td');
                searchVolumeCell.style.textAlign = 'right';
                searchVolumeCell.textContent = kw.searchVolume ? kw.searchVolume.toLocaleString() : 'N/A';
                
                // Create CPC cell
                const cpcCell = document.createElement('td');
                cpcCell.style.textAlign = 'right';
                cpcCell.textContent = kw.cpc ? `$${kw.cpc.toFixed(2)}` : '$N/A';
                
                // Create competition cell
                const competitionCell = document.createElement('td');
                competitionCell.style.textAlign = 'right';
                competitionCell.textContent = kw.competition ? `${(kw.competition * 100).toFixed(1)}%` : 'N/A';
                
                // Create results cell
                const resultsCell = document.createElement('td');
                resultsCell.style.textAlign = 'right';
                resultsCell.textContent = kw.results ? kw.results.toLocaleString() : 'N/A';
                
                // Create intent cell
                const intentCell = document.createElement('td');
                intentCell.textContent = kw.intent || 'N/A';
                
                // Create action cell with button
                const actionCell = document.createElement('td');
                actionCell.style.textAlign = 'center';
                const addButton = document.createElement('button');
                addButton.className = 'add-keyword-btn';
                addButton.textContent = 'Add';
                
                // Add secure event listener instead of onclick
                addButton.addEventListener('click', function() {
                    window.addKeywordToInput(kw.keyword || '');
                });
                
                actionCell.appendChild(addButton);
                
                // Append all cells to row
                row.appendChild(typeCell);
                row.appendChild(keywordCell);
                row.appendChild(searchVolumeCell);
                row.appendChild(cpcCell);
                row.appendChild(competitionCell);
                row.appendChild(resultsCell);
                row.appendChild(intentCell);
                row.appendChild(actionCell);
                
                keywordsTableBody.appendChild(row);
            });
        }

        function setupTableSorting() {
            const sortableHeaders = document.querySelectorAll('#keywords-table th.sortable');
            
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const sortBy = this.getAttribute('data-sort');
                    
                    // Toggle sort direction if clicking the same column
                    if (currentSortColumn === sortBy) {
                        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = sortBy;
                        currentSortDirection = 'asc';
                    }
                    
                    // Update sort indicators
                    sortableHeaders.forEach(h => {
                        h.classList.remove('sorted-asc', 'sorted-desc');
                        h.querySelector('.sort-arrow').textContent = 'â†•';
                    });
                    
                    this.classList.add(`sorted-${currentSortDirection}`);
                    this.querySelector('.sort-arrow').textContent = currentSortDirection === 'asc' ? 'â†‘' : 'â†“';
                    
                    // Sort the data
                    const sortedData = [...allKeywordsData].sort((a, b) => {
                        let aVal = a[sortBy];
                        let bVal = b[sortBy];
                        
                        // Handle different data types
                        if (sortBy === 'searchVolume' || sortBy === 'results') {
                            aVal = aVal || 0;
                            bVal = bVal || 0;
                        } else if (sortBy === 'cpc' || sortBy === 'competition') {
                            aVal = aVal || 0;
                            bVal = bVal || 0;
                        } else {
                            aVal = (aVal || '').toString().toLowerCase();
                            bVal = (bVal || '').toString().toLowerCase();
                        }
                        
                        if (currentSortDirection === 'asc') {
                            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                        } else {
                            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                        }
                    });
                    
                    // Re-populate table with sorted data
                    populateKeywordsTable(sortedData);
                });
            });
        }
        
        function createKeywordSuggestionItem(keyword) {
            const item = document.createElement('div');
            item.className = 'keyword-item';
            item.style.cursor = 'pointer';
            item.style.transition = 'background-color 0.2s';
            
            item.innerHTML = `
                <div style="flex: 1;">
                    <strong>${keyword.keyword}</strong>
                    <div style="font-size: 12px; color: #666;">
                        Vol: ${keyword.searchVolume || 'N/A'} | 
                        CPC: $${keyword.cpc ? keyword.cpc.toFixed(2) : 'N/A'} | 
                        Comp: ${keyword.competition ? (keyword.competition * 100).toFixed(1) + '%' : 'N/A'}
                    </div>
                </div>
                <button class="add-keyword-suggestion-btn" style="padding: 5px 10px; background-color: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    Add
                </button>
            `;
            
            // Add hover effect
            item.addEventListener('mouseenter', () => {
                item.style.backgroundColor = '#f0f8ff';
            });
            
            item.addEventListener('mouseleave', () => {
                item.style.backgroundColor = '';
            });
            
            // Add click handler for adding keyword
            const addBtn = item.querySelector('.add-keyword-suggestion-btn');
            addBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                addKeywordToInput(keyword.keyword);
            });
            
            return item;
        }
        
        function addKeywordToInput(keyword) {
            const currentKeywords = keywordsInput.value.trim();
            if (currentKeywords) {
                keywordsInput.value = currentKeywords + '\n' + keyword;
            } else {
                keywordsInput.value = keyword;
            }
            
            // Flash the input to show keyword was added
            keywordsInput.style.backgroundColor = '#e8f5e8';
            setTimeout(() => {
                keywordsInput.style.backgroundColor = '';
            }, 300);
        }
        
        // Make addKeywordToInput globally accessible
        window.addKeywordToInput = addKeywordToInput;
        
        function addKeywords(campaignId, adGroupId, keywords, matchTypes) {
            if (!campaignsData[campaignId].keywords) {
                campaignsData[campaignId].keywords = {};
            }
            
            if (!campaignsData[campaignId].keywords[adGroupId]) {
                campaignsData[campaignId].keywords[adGroupId] = [];
            }
            
            for (const keyword of keywords) {
                for (const matchType of matchTypes) {
                    campaignsData[campaignId].keywords[adGroupId].push({
                        text: keyword,
                        matchType: matchType
                    });
                }
            }
            
            saveData();
            updateKeywordList();
        }
        
        function updateKeywordList() {
            const campaignId = keywordCampaignSelect.value;
            const adGroupId = keywordAdGroupSelect.value;
            
            if (!campaignId || !adGroupId) {
                keywordListContainer.innerHTML = `
                    <div class="keyword-list">
                        <p>Select an ad group to view keywords</p>
                    </div>
                `;
                return;
            }
            
            const keywords = campaignsData[campaignId].keywords && 
                            campaignsData[campaignId].keywords[adGroupId] ? 
                            campaignsData[campaignId].keywords[adGroupId] : [];
            
            if (keywords.length === 0) {
                keywordListContainer.innerHTML = `
                    <div class="keyword-list">
                        <p>No keywords in this ad group</p>
                    </div>
                `;
                return;
            }
            
            let keywordListHTML = '<div class="keyword-list">';
            for (let i = 0; i < keywords.length; i++) {
                const keyword = keywords[i];
                let badgeClass = '';
                
                switch (keyword.matchType) {
                    case 'exact':
                        badgeClass = 'badge-exact';
                        break;
                    case 'phrase':
                        badgeClass = 'badge-phrase';
                        break;
                    case 'broad':
                        badgeClass = 'badge-broad';
                        break;
                }
                
                keywordListHTML += `
                    <div class="keyword-item">
                        <div>${keyword.text}</div>
                        <div>
                            <span class="badge ${badgeClass}">${keyword.matchType}</span>
                            <button class="delete-btn" data-keyword-index="${i}">X</button>
                        </div>
                    </div>
                `;
            }
            keywordListHTML += '</div>';
            
            keywordListContainer.innerHTML = keywordListHTML;
            
            // Add event listeners to delete buttons
            const deleteButtons = keywordListContainer.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const index = parseInt(button.getAttribute('data-keyword-index'));
                    deleteKeyword(campaignId, adGroupId, index);
                });
            });
        }
        
        function deleteKeyword(campaignId, adGroupId, index) {
            campaignsData[campaignId].keywords[adGroupId].splice(index, 1);
            saveData();
            updateKeywordList();
        }
        
        // Ad Copy
        function setupAdCopy() {
            // Initialize the Agentic Ad Copy Generator
            const agenticAdCopyGenerator = new AgenticAdCopyGenerator();
            
            adCampaignSelect.addEventListener('change', () => {
                updateAdGroupSelect(adCampaignSelect.value, adGroupSelect);
                updateAdsList();
                updateKeywordCoverageAnalysis();
            });
            
            adGroupSelect.addEventListener('change', () => {
                updateAdsList();
                updateKeywordCoverageAnalysis();
            });

            saveAdBtn.addEventListener('click', () => {
                const campaignId = adCampaignSelect.value;
                const adGroupId = adGroupSelect.value;
                
                if (!campaignId || !adGroupId) {
                    alert('Please select a campaign and ad group.');
                    return;
                }
                
                if (!headline1.value || !description1.value) {
                    alert('Headline 1 and Description 1 are required.');
                    return;
                }
                
                saveAd(campaignId, adGroupId);
                updateKeywordCoverageAnalysis();
            });
            
            // Keyword Coverage Analysis
            refreshAnalysisBtn.addEventListener('click', () => {
                updateKeywordCoverageAnalysis();
            });
            
            // Monitor ad copy changes for real-time analysis
            const adInputs = [headline1, headline2, headline3, headline4, headline5, headline6, 
                             headline7, headline8, headline9, headline10, headline11,
                             description1, description2, description3, description4];
            
            adInputs.forEach(input => {
                input.addEventListener('input', debounce(updateKeywordCoverageAnalysis, 500));
            });
        }
        
        function saveAd(campaignId, adGroupId) {
            if (!campaignsData[campaignId].ads) {
                campaignsData[campaignId].ads = {};
            }
            
            if (!campaignsData[campaignId].ads[adGroupId]) {
                campaignsData[campaignId].ads[adGroupId] = [];
            }
            
            const adId = 'ad_' + Date.now();
            campaignsData[campaignId].ads[adGroupId].push({
                id: adId,
                headline1: headline1.value,
                headline2: headline2.value,
                headline3: headline3.value,
                headline4: headline4.value,
                headline5: headline5.value,
                headline6: headline6.value,
                headline7: headline7.value,
                headline8: headline8.value,
                headline9: headline9.value,
                headline10: headline10.value,
                headline11: headline11.value,
                headline12: headline12.value,
                headline13: headline13.value,
                headline14: headline14.value,
                headline15: headline15.value,
                description1: description1.value,
                description2: description2.value,
                description3: description3.value,
                description4: description4.value
            });
            
            saveData();
            updateAdsList();
            
            // Show success message
            adSaveMessage.textContent = 'Ad saved successfully!';
            setTimeout(() => {
                adSaveMessage.textContent = '';
            }, 3000);
            
            // Clear form
            headline1.value = '';
            headline2.value = '';
            headline3.value = '';
            headline4.value = '';
            headline5.value = '';
            headline6.value = '';
            headline7.value = '';
            headline8.value = '';
            headline9.value = '';
            headline10.value = '';
            headline11.value = '';
            headline12.value = '';
            headline13.value = '';
            headline14.value = '';
            headline15.value = '';
            description1.value = '';
            description2.value = '';
            description3.value = '';
            description4.value = '';
        }
        
        function updateAdsList() {
            const campaignId = adCampaignSelect.value;
            const adGroupId = adGroupSelect.value;
            
            if (!campaignId || !adGroupId) {
                adsListContainer.innerHTML = `
                    <div class="keyword-list">
                        <p>Select an ad group to view ads</p>
                    </div>
                `;
                return;
            }
            
            const ads = campaignsData[campaignId].ads && 
                       campaignsData[campaignId].ads[adGroupId] ? 
                       campaignsData[campaignId].ads[adGroupId] : [];
            
            if (ads.length === 0) {
                adsListContainer.innerHTML = `
                    <div class="keyword-list">
                        <p>No ads in this ad group</p>
                    </div>
                `;
                return;
            }
            
            let adsListHTML = '';
            for (let i = 0; i < ads.length; i++) {
                const ad = ads[i];
                adsListHTML += `
                    <div class="keyword-list">
                        <h4>Ad ${i + 1}</h4>
                        <div class="keyword-item">
                            <div><strong>Headline 1:</strong> ${ad.headline1}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 2:</strong> ${ad.headline2 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 3:</strong> ${ad.headline3 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 4:</strong> ${ad.headline4 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 5:</strong> ${ad.headline5 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 6:</strong> ${ad.headline6 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 7:</strong> ${ad.headline7 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 8:</strong> ${ad.headline8 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 9:</strong> ${ad.headline9 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 10:</strong> ${ad.headline10 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 11:</strong> ${ad.headline11 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 12:</strong> ${ad.headline12 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 13:</strong> ${ad.headline13 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 14:</strong> ${ad.headline14 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Headline 15:</strong> ${ad.headline15 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Description 1:</strong> ${ad.description1}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Description 2:</strong> ${ad.description2 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Description 3:</strong> ${ad.description3 || 'N/A'}</div>
                        </div>
                        <div class="keyword-item">
                            <div><strong>Description 4:</strong> ${ad.description4 || 'N/A'}</div>
                        </div>
                        <button class="delete-btn" data-ad-index="${i}">Delete Ad</button>
                    </div>
                `;
            }
            
            adsListContainer.innerHTML = adsListHTML;
            
            // Add event listeners to delete buttons
            const deleteButtons = adsListContainer.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const index = parseInt(button.getAttribute('data-ad-index'));
                    deleteAd(campaignId, adGroupId, index);
                });
            });
        }
        
        function deleteAd(campaignId, adGroupId, index) {
            campaignsData[campaignId].ads[adGroupId].splice(index, 1);
            saveData();
            updateAdsList();
            updateKeywordCoverageAnalysis();
        }
        
        // Keyword Coverage Analysis Variables
        let coverageChart = null;
        
        // Keyword Coverage Analysis Functions
        function updateKeywordCoverageAnalysis() {
            const campaignId = adCampaignSelect.value;
            const adGroupId = adGroupSelect.value;
            
            if (!campaignId || !adGroupId) {
                keywordCoverageAnalysis.style.display = 'none';
                return;
            }
            
            // Get current ad copy
            const currentAdCopy = getCurrentAdCopy();
            
            // Get saved keywords for this ad group
            const savedKeywords = getSavedKeywords(campaignId, adGroupId);
            
            if (savedKeywords.length === 0) {
                keywordCoverageAnalysis.style.display = 'none';
                return;
            }
            
            // Show the analysis section
            keywordCoverageAnalysis.style.display = 'block';
            
            // Perform keyword coverage analysis
            const analysis = analyzeKeywordCoverage(currentAdCopy, savedKeywords);
            
            // Update UI with analysis results
            displayCoverageResults(analysis);
        }
        
        function getCurrentAdCopy() {
            return {
                headlines: [
                    headline1.value, headline2.value, headline3.value, headline4.value,
                    headline5.value, headline6.value, headline7.value, headline8.value,
                    headline9.value, headline10.value, headline11.value, headline12.value,
                    headline13.value, headline14.value, headline15.value
                ].filter(h => h.trim() !== ''),
                descriptions: [
                    description1.value, description2.value, description3.value, description4.value
                ].filter(d => d.trim() !== '')
            };
        }
        
        function getSavedKeywords(campaignId, adGroupId) {
            if (!campaignsData[campaignId] || !campaignsData[campaignId].keywords || 
                !campaignsData[campaignId].keywords[adGroupId]) {
                return [];
            }
            
            return campaignsData[campaignId].keywords[adGroupId];
        }
        
        function analyzeKeywordCoverage(adCopy, keywords) {
            const allAdText = [...adCopy.headlines, ...adCopy.descriptions].join(' ').toLowerCase();
            
            let coveredCount = 0;
            let partialCount = 0;
            let missingCount = 0;
            
            const keywordDetails = keywords.map(keyword => {
                const keywordText = keyword.text.toLowerCase();
                const keywordWords = keywordText.split(' ');
                
                // Check for exact keyword match
                if (allAdText.includes(keywordText)) {
                    coveredCount++;
                    return {
                        keyword: keyword.text,
                        matchType: keyword.matchType,
                        status: 'covered',
                        coverage: 100,
                        foundIn: findKeywordInSections(keyword.text, adCopy)
                    };
                }
                
                // Check for partial match (individual words)
                let matchedWords = 0;
                keywordWords.forEach(word => {
                    if (allAdText.includes(word.toLowerCase())) {
                        matchedWords++;
                    }
                });
                
                const coveragePercentage = Math.round((matchedWords / keywordWords.length) * 100);
                
                if (coveragePercentage >= 50) {
                    partialCount++;
                    return {
                        keyword: keyword.text,
                        matchType: keyword.matchType,
                        status: 'partial',
                        coverage: coveragePercentage,
                        foundIn: findKeywordInSections(keyword.text, adCopy)
                    };
                } else {
                    missingCount++;
                    return {
                        keyword: keyword.text,
                        matchType: keyword.matchType,
                        status: 'missing',
                        coverage: coveragePercentage,
                        foundIn: []
                    };
                }
            });
            
            const totalKeywords = keywords.length;
            const overallCoverage = Math.round(((coveredCount + (partialCount * 0.5)) / totalKeywords) * 100);
            
            return {
                totalKeywords,
                coveredCount,
                partialCount,
                missingCount,
                overallCoverage,
                keywordDetails
            };
        }
        
        function findKeywordInSections(keyword, adCopy) {
            const foundIn = [];
            const keywordLower = keyword.toLowerCase();
            
            // Check headlines
            adCopy.headlines.forEach((headline, index) => {
                if (headline.toLowerCase().includes(keywordLower)) {
                    foundIn.push(`Headline ${index + 1}`);
                }
            });
            
            // Check descriptions
            adCopy.descriptions.forEach((description, index) => {
                if (description.toLowerCase().includes(keywordLower)) {
                    foundIn.push(`Description ${index + 1}`);
                }
            });
            
            return foundIn;
        }
        
        function displayCoverageResults(analysis) {
            // Update main metrics
            coverageScore.textContent = `Coverage: ${analysis.overallCoverage}%`;
            totalKeywordsEl.textContent = analysis.totalKeywords;
            coveredKeywordsEl.textContent = analysis.coveredCount;
            partialKeywordsEl.textContent = analysis.partialCount;
            missingKeywordsEl.textContent = analysis.missingCount;
            
            // Update the coverage score color based on performance
            coverageScore.className = 'coverage-score';
            if (analysis.overallCoverage >= 80) {
                coverageScore.style.background = 'linear-gradient(135deg, #4caf50, #81c784)';
            } else if (analysis.overallCoverage >= 60) {
                coverageScore.style.background = 'linear-gradient(135deg, #ff9800, #ffb74d)';
            } else {
                coverageScore.style.background = 'linear-gradient(135deg, #f44336, #e57373)';
            }
            
            // Update keyword coverage list
            displayKeywordDetails(analysis.keywordDetails);
            
            // Update chart
            updateCoverageChart(analysis);
        }
        
        function displayKeywordDetails(keywordDetails) {
            let html = '';
            
            keywordDetails.forEach(detail => {
                const statusClass = `keyword-${detail.status}`;
                const statusText = detail.status === 'covered' ? 'Fully Covered' : 
                                 detail.status === 'partial' ? `Partial (${detail.coverage}%)` : 'Not Covered';
                const statusBadgeClass = `status-${detail.status}`;
                
                let foundInText = '';
                if (detail.foundIn.length > 0) {
                    foundInText = ` - Found in: ${detail.foundIn.join(', ')}`;
                }
                
                html += `
                    <div class="keyword-coverage-item ${statusClass}">
                        <div>
                            <strong>${detail.keyword}</strong>
                            <span class="badge badge-${detail.matchType}">${detail.matchType}</span>
                            ${foundInText}
                        </div>
                        <span class="coverage-status ${statusBadgeClass}">${statusText}</span>
                    </div>
                `;
            });
            
            keywordCoverageList.innerHTML = html;
        }
        
        function updateCoverageChart(analysis) {
            const ctx = document.getElementById('coverage-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (coverageChart) {
                coverageChart.destroy();
            }
            
            coverageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Fully Covered', 'Partially Covered', 'Not Covered'],
                    datasets: [{
                        data: [analysis.coveredCount, analysis.partialCount, analysis.missingCount],
                        backgroundColor: ['#4caf50', '#ff9800', '#f44336'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = analysis.totalKeywords;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '50%'
                }
            });
        }
        
        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Export
        function setupExport() {
            exportBtn.addEventListener('click', () => {
                const campaignId = exportCampaignSelect.value;
                const format = exportFormatSelect.value;
                
                if (!campaignId) {
                    alert('Please select a campaign to export.');
                    return;
                }
                
                exportCampaign(campaignId, format);
            });
        }
        
        function exportCampaign(campaignId, format) {
            const campaign = campaignsData[campaignId];
            
            if (!campaign) {
                alert('Campaign not found.');
                return;
            }
            
            let exportData;
            let fileName;
            let mimeType;
            
            switch (format) {
                case 'csv':
                    // Generate separate CSV files for ads and keywords
                    generateSeparateCSVExport(campaignId);
                    return;
                case 'excel':
                    alert('Excel export is not implemented in this version.');
                    return;
                case 'json':
                    exportData = JSON.stringify(campaign, null, 2);
                    fileName = `${campaign.name.replace(/\s+/g, '_')}_google_ads.json`;
                    mimeType = 'application/json';
                    break;
                default:
                    alert('Invalid export format.');
                    return;
            }
            
            // Create download link
            const blob = new Blob([exportData], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.textContent = 'Download ' + fileName;
            
            // Show download link
            exportResult.innerHTML = '';
            exportResult.appendChild(a);
            
            // Automatically click the link to start download
            a.click();
        }
        
        function generateSeparateCSVExport(campaignId) {
            const campaign = campaignsData[campaignId];
            const clientInfo = getClientInfo();
            
            // Generate ads CSV
            const adsCSV = generateAdsCSV(campaignId);
            
            // Generate keywords CSV
            const keywordsCSV = generateKeywordsCSV(campaignId);
            
            // Create separate download links for each CSV
            const campaignNameClean = campaign.name.replace(/\s+/g, '_');
            
            // Create ads CSV download
            const adsBlob = new Blob([adsCSV], { type: 'text/csv' });
            const adsUrl = URL.createObjectURL(adsBlob);
            const adsLink = document.createElement('a');
            adsLink.href = adsUrl;
            adsLink.download = `${campaignNameClean}_ads.csv`;
            adsLink.textContent = `Download ${campaignNameClean}_ads.csv`;
            adsLink.style.display = 'block';
            adsLink.style.marginBottom = '10px';
            
            // Create keywords CSV download
            const keywordsBlob = new Blob([keywordsCSV], { type: 'text/csv' });
            const keywordsUrl = URL.createObjectURL(keywordsBlob);
            const keywordsLink = document.createElement('a');
            keywordsLink.href = keywordsUrl;
            keywordsLink.download = `${campaignNameClean}_keywords.csv`;
            keywordsLink.textContent = `Download ${campaignNameClean}_keywords.csv`;
            keywordsLink.style.display = 'block';
            keywordsLink.style.marginBottom = '10px';
            
            // Show download links
            exportResult.innerHTML = '<h4>Download your CSV files:</h4>';
            exportResult.appendChild(adsLink);
            exportResult.appendChild(keywordsLink);
            
            // Automatically start downloads
            setTimeout(() => adsLink.click(), 100);
            setTimeout(() => keywordsLink.click(), 500);
        }
        
        function generateAdsCSV(campaignId) {
            const campaign = campaignsData[campaignId];
            const clientInfo = getClientInfo();
            
            // CSV Header for ads
            let csv = 'Campaign,Ad Group,Headline 1,Headline 2,Headline 3,Headline 4,Headline 5,Headline 6,Headline 7,Headline 8,Headline 9,Headline 10,Headline 11,Headline 12,Headline 13,Headline 14,Headline 15,Description 1,Description 2,Description 3,Description 4,Final URL\n';
            
            // Process each ad group
            for (const adGroupId in campaign.adGroups) {
                const adGroup = campaign.adGroups[adGroupId];
                const adGroupName = adGroup.name;
                
                // Process ads
                const ads = campaign.ads && campaign.ads[adGroupId] ? campaign.ads[adGroupId] : [];
                for (const ad of ads) {
                    csv += `"${campaign.name}","${adGroupName}","${ad.headline1 || ''}","${ad.headline2 || ''}","${ad.headline3 || ''}","${ad.headline4 || ''}","${ad.headline5 || ''}","${ad.headline6 || ''}","${ad.headline7 || ''}","${ad.headline8 || ''}","${ad.headline9 || ''}","${ad.headline10 || ''}","${ad.headline11 || ''}","${ad.headline12 || ''}","${ad.headline13 || ''}","${ad.headline14 || ''}","${ad.headline15 || ''}","${ad.description1 || ''}","${ad.description2 || ''}","${ad.description3 || ''}","${ad.description4 || ''}","${clientInfo.websiteUrl || ''}"\n`;
                }
            }
            
            return csv;
        }
        
        function generateKeywordsCSV(campaignId) {
            const campaign = campaignsData[campaignId];
            
            // CSV Header for keywords
            let csv = 'Campaign,Ad Group,Keyword,Match Type\n';
            
            // Process each ad group
            for (const adGroupId in campaign.adGroups) {
                const adGroup = campaign.adGroups[adGroupId];
                const adGroupName = adGroup.name;
                
                // Process keywords
                const keywords = campaign.keywords && campaign.keywords[adGroupId] ? campaign.keywords[adGroupId] : [];
                for (const keyword of keywords) {
                    csv += `"${campaign.name}","${adGroupName}","${keyword.text}","${keyword.matchType}"\n`;
                }
            }
            
            return csv;
        }
        
        function generateCSV(campaignId) {
            const campaign = campaignsData[campaignId];
            const clientInfo = getClientInfo();
            
            // CSV Header - removed Path 1 and Path 2 columns that don't exist
            let csv = 'Campaign,Ad Group,Headline 1,Headline 2,Headline 3,Headline 4,Headline 5,Headline 6,Headline 7,Headline 8,Headline 9,Headline 10,Headline 11,Headline 12,Headline 13,Headline 14,Headline 15,Description 1,Description 2,Description 3,Description 4,Final URL,Keyword,Match Type\n';
            
            // Process each ad group
            for (const adGroupId in campaign.adGroups) {
                const adGroup = campaign.adGroups[adGroupId];
                const adGroupName = adGroup.name;
                
                // Process ads - removed references to path1 and path2
                const ads = campaign.ads && campaign.ads[adGroupId] ? campaign.ads[adGroupId] : [];
                for (const ad of ads) {
                    csv += `"${campaign.name}","${adGroupName}","${ad.headline1 || ''}","${ad.headline2 || ''}","${ad.headline3 || ''}","${ad.headline4 || ''}","${ad.headline5 || ''}","${ad.headline6 || ''}","${ad.headline7 || ''}","${ad.headline8 || ''}","${ad.headline9 || ''}","${ad.headline10 || ''}","${ad.headline11 || ''}","${ad.headline12 || ''}","${ad.headline13 || ''}","${ad.headline14 || ''}","${ad.headline15 || ''}","${ad.description1 || ''}","${ad.description2 || ''}","${ad.description3 || ''}","${ad.description4 || ''}","${clientInfo.websiteUrl || ''}",,\n`;
                }
                
                // Process keywords - fixed column alignment (17 empty columns total: 2 campaign/adgroup + 11 headlines + 4 descriptions + 1 final URL = 18 columns before keyword)
                const keywords = campaign.keywords && campaign.keywords[adGroupId] ? campaign.keywords[adGroupId] : [];
                for (const keyword of keywords) {
                    csv += `"${campaign.name}","${adGroupName}",,,,,,,,,,,,,,,,,"${clientInfo.websiteUrl || ''}","${keyword.text}","${keyword.matchType}"\n`;
                }
            }
            
            return csv;
        }
        
        // Character Counters
        function setupCharacterCounters() {
            // Add character count listeners for all form fields
            headline1.addEventListener('input', () => updateCharacterCount(headline1, headline1Count));
            headline2.addEventListener('input', () => updateCharacterCount(headline2, headline2Count));
            headline3.addEventListener('input', () => updateCharacterCount(headline3, headline3Count));
            headline4.addEventListener('input', () => updateCharacterCount(headline4, headline4Count));
            headline5.addEventListener('input', () => updateCharacterCount(headline5, headline5Count));
            headline6.addEventListener('input', () => updateCharacterCount(headline6, headline6Count));
            headline7.addEventListener('input', () => updateCharacterCount(headline7, headline7Count));
            headline8.addEventListener('input', () => updateCharacterCount(headline8, headline8Count));
            headline9.addEventListener('input', () => updateCharacterCount(headline9, headline9Count));
            headline10.addEventListener('input', () => updateCharacterCount(headline10, headline10Count));
            headline11.addEventListener('input', () => updateCharacterCount(headline11, headline11Count));
            headline12.addEventListener('input', () => updateCharacterCount(headline12, headline12Count));
            headline13.addEventListener('input', () => updateCharacterCount(headline13, headline13Count));
            headline14.addEventListener('input', () => updateCharacterCount(headline14, headline14Count));
            headline15.addEventListener('input', () => updateCharacterCount(headline15, headline15Count));
            description1.addEventListener('input', () => updateCharacterCount(description1, description1Count));
            description2.addEventListener('input', () => updateCharacterCount(description2, description2Count));
            description3.addEventListener('input', () => updateCharacterCount(description3, description3Count));
            description4.addEventListener('input', () => updateCharacterCount(description4, description4Count));
            
            // Initialize character counts
            updateCharacterCount(headline1, headline1Count);
            updateCharacterCount(headline2, headline2Count);
            updateCharacterCount(headline3, headline3Count);
            updateCharacterCount(headline4, headline4Count);
            updateCharacterCount(headline5, headline5Count);
            updateCharacterCount(headline6, headline6Count);
            updateCharacterCount(headline7, headline7Count);
            updateCharacterCount(headline8, headline8Count);
            updateCharacterCount(headline9, headline9Count);
            updateCharacterCount(headline10, headline10Count);
            updateCharacterCount(headline11, headline11Count);
            updateCharacterCount(headline12, headline12Count);
            updateCharacterCount(headline13, headline13Count);
            updateCharacterCount(headline14, headline14Count);
            updateCharacterCount(headline15, headline15Count);
            updateCharacterCount(description1, description1Count);
            updateCharacterCount(description2, description2Count);
            updateCharacterCount(description3, description3Count);
            updateCharacterCount(description4, description4Count);
        }
        
        function updateCharacterCount(inputElement, countElement) {
            const maxLength = inputElement.getAttribute('maxlength');
            const currentLength = inputElement.value.length;
            countElement.textContent = `${currentLength}/${maxLength}`;
            
            // Check if this is a headline field (maxlength 30)
            if (parseInt(maxLength) === 30) {
                if (currentLength >= 25 && currentLength <= 30) {
                    // Optimal range for headlines (25-30 chars)
                    countElement.style.color = '#4caf50';
                } else if (currentLength >= 20 && currentLength < 25) {
                    // Acceptable but could be longer
                    countElement.style.color = '#ff9800';
                } else if (currentLength > 30) {
                    // Over limit
                    countElement.style.color = '#ea4335';
                } else {
                    // Too short
                    countElement.style.color = '#666';
                }
            } else {
                // Original logic for descriptions
                if (currentLength >= parseInt(maxLength)) {
                    countElement.style.color = '#ea4335';
                } else {
                    countElement.style.color = '#666';
                }
            }
        }
        
        // Helper Functions
        function updateSelects() {
            // Clear all selects
            keywordCampaignSelect.innerHTML = '<option value="">Select a campaign</option>';
            keywordAdGroupSelect.innerHTML = '<option value="">Select an ad group</option>';
            adCampaignSelect.innerHTML = '<option value="">Select a campaign</option>';
            adGroupSelect.innerHTML = '<option value="">Select an ad group</option>';
            exportCampaignSelect.innerHTML = '<option value="">Select a campaign</option>';
            
            // Add campaigns to selects
            for (const campaignId in campaignsData) {
                const campaign = campaignsData[campaignId];
                const unitTypeIndicator = campaign.isUnitType ? ' (Unit Type)' : '';
                
                const option = document.createElement('option');
                option.value = campaignId;
                option.textContent = campaign.name + unitTypeIndicator;
                
                keywordCampaignSelect.appendChild(option.cloneNode(true));
                adCampaignSelect.appendChild(option.cloneNode(true));
                exportCampaignSelect.appendChild(option.cloneNode(true));
            }
        }
        
        function updateAdGroupSelect(campaignId, selectElement) {
            selectElement.innerHTML = '<option value="">Select an ad group</option>';
            
            if (!campaignId || !campaignsData[campaignId] || !campaignsData[campaignId].adGroups) {
                return;
            }
            
            for (const adGroupId in campaignsData[campaignId].adGroups) {
                const adGroup = campaignsData[campaignId].adGroups[adGroupId];
                
                const option = document.createElement('option');
                option.value = adGroupId;
                option.textContent = adGroup.name;
                
                selectElement.appendChild(option);
            }
        }
        
        function saveClientInfo() {
            const clientInfo = getClientInfo();
            localStorage.setItem('clientInfo', JSON.stringify(clientInfo));
        }
        
        function getClientInfo() {
            return {
                clientName: clientName.value,
                websiteUrl: websiteUrl.value,
                industry: industry.value,
                targetAudience: targetAudience.value,
                geographicTargeting: geographicTargeting.value,
                uniqueSellingPoints: uniqueSellingPoints.value,
                competitors: competitors.value,
                brandVoice: brandVoice.value,
                callToAction: callToAction.value,
                budget: budget.value
            };
        }
        
        function loadClientInfo() {
            const savedClientInfo = localStorage.getItem('clientInfo');
            if (savedClientInfo) {
                const clientInfo = JSON.parse(savedClientInfo);
                
                clientName.value = clientInfo.clientName || '';
                websiteUrl.value = clientInfo.websiteUrl || '';
                industry.value = clientInfo.industry || '';
                targetAudience.value = clientInfo.targetAudience || '';
                geographicTargeting.value = clientInfo.geographicTargeting || '';
                uniqueSellingPoints.value = clientInfo.uniqueSellingPoints || '';
                competitors.value = clientInfo.competitors || '';
                brandVoice.value = clientInfo.brandVoice || '';
                callToAction.value = clientInfo.callToAction || '';
                budget.value = clientInfo.budget || '';
            }
        }
        
        function saveData() {
            localStorage.setItem('campaignsData', JSON.stringify(campaignsData));
        }
        
        function loadData() {
            const savedCampaignsData = localStorage.getItem('campaignsData');
            if (savedCampaignsData) {
                campaignsData = JSON.parse(savedCampaignsData);
                window.campaignsData = campaignsData; // Update global reference
            }
            
            loadClientInfo();
        }
        
        // Add a function to show a note based on campaign type
        function showUnitTypeNote() {
            const campaignId = keywordCampaignSelect.value;
            const noteId = 'campaign-type-note';
            let note = document.getElementById(noteId);
            
            // Remove existing note
            if (note) note.remove();
            
            if (campaignId && campaignsData[campaignId]) {
                const campaign = campaignsData[campaignId];
                note = document.createElement('div');
                note.id = noteId;
                note.style.padding = '10px';
                note.style.margin = '10px 0';
                note.style.borderRadius = '4px';
                
                if (campaign.isUnitType) {
                    note.style.background = '#fffbe6';
                    note.style.border = '1px solid #ffe58f';
                    note.style.color = '#ad8b00';
                    note.innerHTML = '<b>Unit Type Campaign:</b> Keyword generation will be strictly based on the ad group name (e.g., "Three Bedroom Homes").';
                } else {
                    note.style.background = '#e8f5e8';
                    note.style.border = '1px solid #4caf50';
                    note.style.color = '#2e7d32';
                    note.innerHTML = '<b>General Search Campaign:</b> Keyword generation will focus on location-based terms covering Location, New Apts, Near, and Access To classifications. The "Location" ad group has been automatically created.';
                }
                
                keywordCampaignSelect.parentElement.parentElement.insertBefore(note, keywordCampaignSelect.parentElement.nextSibling);
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
